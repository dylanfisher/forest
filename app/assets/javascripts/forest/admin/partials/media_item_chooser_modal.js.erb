App.MediaItemChooser = {
  instances: [],
  initialize: function($elements) {
    var that = this;

    $(document).one('turbolinks:before-cache.mediaItemChooser', function() {
      that.teardown();
    });

    $elements.each(function() {
      var $element = $(this);

      that.instances.push( $element );

      $element
        .on('show.bs.modal', function(e) {
          var $modalBody = $element.find('.modal-body');

          if ( $modalBody.find('.media-library').length ) {
            App.InfiniteLoader.initialize( $element.find('[data-infinite-load]'), { $scrollListener: $element } );
          } else {
            $.ajax('<%= Rails.application.routes.url_helpers.media_items_path %>')
              .done(function(data) {
                $modalBody.html( $(data).find('.media-library') );
                App.InfiniteLoader.initialize( $element.find('[data-infinite-load]'), { $scrollListener: $element } );
              }).fail(function() {
                var error = 'Unable to fetch media items index.';
                console.warn(error);
                $modalBody.html(error);
              });
          }
        })
        .on('shown.bs.modal', function() {
          $(document).trigger('app:show-media-item-chooser');
        })
        .on('hide.bs.modal', function() {
          that.destroyModal();
        })
        .on('hidden.bs.modal', function() {
          $('.media-item-chooser .media-library-link--selected').removeClass('media-library-link--selected');
        });
    });
  },
  destroyModal: function() {
    for ( var i = this.instances.length - 1; i >= 0; i-- ) {
      App.InfiniteLoader.unbindScroll( this.instances[i] );
    }
    $('.media-item-chooser__button--active').removeClass('media-item-chooser__button--active');
  },
  createThumbnail: function(id, url) {
    return '<div class="media-item--grid col-xs-4 col-sm-3 col-md-2">' +
      '<div class="media-library-image img-rounded " style="background-image: url(' + url + ')" data-media-item-id="' + id + '" data-media-item-url="' + url + '"></div>' +
    '</div>';
  },
  teardown: function() {
    this.destroyModal();
    for ( var i = this.instances.length - 1; i >= 0; i-- ) {
      this.instances[i].removeClass('fade').modal('hide');
    }
    this.instances = [];
    $('.media-item-chooser__button--active').removeClass('media-item-chooser__button--active');
  }
};

App.pageLoad.push(function() {
  App.MediaItemChooser.initialize( $('.media-item-chooser') );
});

$(document).on('click', '[data-media-item-input]', function() {
  App.MediaItemChooser.inputSelector = $(this).attr('data-media-item-input');
  App.MediaItemChooser.input = false;
  App.MediaItemChooser.preview = false;
  App.MediaItemChooser.toPath = $(this).hasClass('media-item-chooser-to-path');
  App.MediaItemChooser.multiple = $(this).attr('data-multiple') == 'true';
});

$(document).on('click', '.media-item-chooser .media-library-link', function(e) {
  e.preventDefault();

  var $wrapper = $('.media-item-chooser__button--active').closest('.image-to-path-wrapper');

  if ( !$wrapper.length ) {
    $wrapper = $('.media-item-chooser__button--active').closest('.image');
  }

  var id = $(this).attr('data-media-item-id');
  var imageUrl = $(this).attr('data-image-url');
  var value = App.MediaItemChooser.toPath ? imageUrl : id;
  var $removeButton = $(this).closest('.image').find('.media-item-chooser__remove-image');

  if ( App.MediaItemChooser.inputSelector ) {
    App.MediaItemChooser.input = $( App.MediaItemChooser.inputSelector );
    App.MediaItemChooser.preview = $( App.MediaItemChooser.inputSelector + '_preview' );

    if ( App.MediaItemChooser.multiple ) {
      // Multiple upload
      $(this).addClass('media-library-link--selected');

    } else {
      // Single item

      App.MediaItemChooser.input.val( value );

      if ( App.MediaItemChooser.preview.length )  {
        App.MediaItemChooser.preview.removeClass('hidden').attr('src', imageUrl);
        $removeButton.removeClass('hidden');
      }

      $(this).closest('.modal').modal('hide');
    }
  }
});

$(document).on('click.mediaItemChooser', '.media-library-link--selected', function() {
  $(this).removeClass('media-library-link--selected');
});

$(document).on('click.mediaItemChooser', '.media-item-chooser__select-button', function() {
  var $selected = $('.media-item-chooser .media-library-link--selected');
  var thumbnails = [];
  var thumbnailIds = [];

  $selected.each(function() {
    var id = $(this).attr('data-media-item-id');
    var url = $(this).attr('data-image-url');
    var $thumbnail = $( App.MediaItemChooser.createThumbnail(id, url) );

    thumbnailIds.push(id);
    thumbnails.push($thumbnail);
  });

  $('.modal.media-item-chooser').modal('hide');

  if ( App.MediaItemChooser.input.length ) {
    thumbnailIds.each(function() {
      // TODO: Not working yet
      App.MediaItemChooser.input.find('option').removeAttr('selected');
      App.MediaItemChooser.input.find('option[value="' + id + '"]').attr('selected', 'selected');
    });
  }

  if ( App.MediaItemChooser.preview.length ) {
    App.MediaItemChooser.preview.append( thumbnails );
  }
});

$(document).on('click.mediaItemChooser', '.media-item-chooser__button, [data-media-item-input]', function() {
  $(this).addClass('media-item-chooser__button--active');
});

$(document).on('click', '.media-item-chooser__remove-image', function() {
  var $wrapper = $(this).closest('.image');
  var $image = $wrapper.find('.media-item-chooser__image');
  var $button = $wrapper.find('.media-item-chooser__button');
  var $input = $( $button.attr('data-media-item-input') );

  $image.attr('src', '').attr('alt', '').addClass('hidden');
  $input.val('');
  $(this).addClass('hidden');
});
