<div class="nested-fields">
  <%= f.association :block_kind,
                    collection: BlockKind.all,
                    include_blank: true,
                    input_html: {
                      class: 'block-kind-select' } %>

  <div class="block-slot-field-templates">
    <% block_kinds.each do |block_kind| %>
      <% klass = block_kind.name.constantize %>
      <%= content_tag :div,
                      class: "block-slot-field-template block-slot-field-template--#{klass.model_name.singular}",
                      data: {
                        block_kind_id: block_kind.id } do %>

        <div class="panel panel-default">
          <div class="panel-heading sortable-handle" data-block-type-header>
            <div class="block-type-header-title">
              <%= content_tag :div, '', class: "nested-fields__panel-display-icon #{klass.display_icon}" %>
              <%= klass.display_name %>
            </div>

            <div class="btn-group pull-right" role="group">
              <button type="button" class="btn btn-xs btn-default" data-block-collapser title="Collapse block">
                <div class="glyphicon glyphicon-minus"></div>
              </button>
              <%= link_to_remove_association f,
                    class: 'btn btn-xs btn-default',
                    title: 'Remove block',
                    data: {
                      confirm: "Are you sure you want to remove this block?" } do %>
                <div class="glyphicon glyphicon-remove"></div>
              <% end %>
            </div>
          </div>

          <div class="panel-body">
            <%= f.simple_fields_for :block, f.object.send(:build_block, klass) do |f| %>
              <%= render "blocks/#{klass.model_name.singular}/edit", f: f %>
            <% end %>
          </div>
        </div>

      <% end %>
    <% end %>
  </div>

  <%= f.association :block_layout, as: :hidden, input_html: { value: block_layout.id } %>
  <%= f.input :block_record_type, as: :hidden %>
  <%= f.input :position, as: :hidden, input_html: { class: 'block-position' } %>
</div>
