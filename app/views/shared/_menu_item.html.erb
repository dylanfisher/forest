<%# TODO: refactor this logic to exist in a MenuItem class %>

<% page = Page.where(id: item['page'].to_i).first %>

<% if item['name'].present? %>
  <% item_name = item['name'] %>
<% else %>
  <% item_name = page.try(:title) %>
<% end %>

<% if item['url'].present? %>
  <% item_url = item['url'] %>
<% elsif page %>
  <% item_url = show_page_path(page) %>
<% else %>
  <% item_url = '' %>
<% end %>

<% classes = ['menu__item'] %>
<% classes.push 'menu__item--with-children' if item['children'].present? %>
<% classes.push "menu__item--#{item_name.parameterize}" if item_name %>
<% classes.push 'menu__item--active' if item['page'].to_i == @page.try(:id) %>
<% classes.push 'menu__item--active' if item_url.sub(/^\//, '') == request.path.split('/').reject(&:blank?).last %>
<% classes.push 'menu__item--active' if item_url == '/' && request.path == '' %>
<% classes.push 'menu__item--active-child' if item_url.sub(/^\//, '') == request.path.split('/').reject(&:blank?).first %>

<%= content_tag :li, class: classes.join(' ') do %>
  <% if item_url.present? %>
    <% link = item_url %>
  <% elsif page.present? %>
    <%# TODO: more performant page lookup? Or just make sure this menu partial is cached properly? %>
    <%# TODO: catch pages that no longer exist %>
    <% link = show_page_path(page) %>
  <% else %>
    <% link = '#' %>
  <% end %>
  <%= link_to item_name, link, class: 'menu__item__link' %>
  <% if item['children'].present? %>
    <%= content_tag :ul, class: "menu__sub-menu" do %>
      <%= render partial: 'shared/menu_item', collection: item['children'], as: 'item' %>
    <% end %>
  <% end %>
<% end %>
